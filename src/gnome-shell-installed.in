#!/bin/bash
# gnome-shell is a plugin for mutter; start mutter with the right
# options.

# About the value of NO_GAIL and NO_AT_BRIDGE: If a11y is enabled,
# gtk_init() will normally load gail and at-bridge. But we don't
# want at-bridge to be loaded until after clutter is initialized
# (which mutter does after initializing gtk) and we don't want
# gail to be loaded at all. So set these flags.  shell_a11y_init()
# will clear them so they don't get passed to gnome-shell's
# children.
export NO_GAIL=1
export NO_AT_BRIDGE=1

# FIXME - Add gjs API to set this stuff and don't depend on the
# environment.  These propagate to child processes.
export GJS_DEBUG_OUTPUT='stderr'
# By default only let gjs show errors and things that are explicitly
# logged via log() from javascript
export GJS_DEBUG_TOPICS='JS ERROR;JS LOG'

if test -z "$MUTTER_PLUGINS"; then
  MUTTER_PLUGINS=libgnome-shell
fi

# Work around Ubuntu xulrunner bug,
# http://bugzilla.gnome.org/show_bug.cgi?id=573413
if test x@ENABLE_DYNAMIC_MOZJS_HACK@ = xyes; then
    sdkdir=$(pkg-config --variable=sdkdir mozilla-js)
    if test -n "${sdkdir}"; then
      mozjs_libdir=$(echo "$sdkdir" | sed -e s,'-\(sdk\|devel\)',,)
      if test -n "$LD_LIBRARY_PATH"; then
	  LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$mozjs_libdir
      else
	  LD_LIBRARY_PATH=$mozjs_libdir
      fi
      export LD_LIBRARY_PATH
   fi
fi

exec mutter --mutter-plugins=$MUTTER_PLUGINS "$@"
